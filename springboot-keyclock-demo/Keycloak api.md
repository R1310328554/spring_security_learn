# 授权 authenticate
POST http://112.74.110.95:8080/auth/realms/master/login-actions/authenticate?session_code=M4BwR2b76dZIJ4jBbins2FZxLiHnrrqew7wRmOtucbw&execution=9446a24a-1875-4ab1-9e53-77c9d6eeaf5f&client_id=security-admin-console&tab_id=lmCJ8OaFt8o

Query String:
session_code: M4BwR2b76dZIJ4jBbins2FZxLiHnrrqew7wRmOtucbw
execution: 9446a24a-1875-4ab1-9e53-77c9d6eeaf5f
client_id: security-admin-console
tab_id: lmCJ8OaFt8o

Form Data:
username=admin&password=admin&credentialId=

响应：
响应头： 302
Location: http://112.74.110.95:8080/auth/admin/master/console/#/realms/demo/clients&state=cb93ed8f-321e-40e0-ae8d-ec0974de4a28&session_state=5bd8c1e9-941a-4e73-a7ca-3bd56bff9ff0&code=61817402-f0bf-465a-9535-ebe57abd7196.5bd8c1e9-941a-4e73-a7ca-3bd56bff9ff0.151cf6cb-2dea-405a-8951-d73e47218b5c
Set-Cookie: KEYCLOAK_LOCALE=; Version=1; Comment=Expiring cookie; Expires=Thu, 01-Jan-1970 00:00:10 GMT; Max-Age=0; Path=/auth/realms/master/; HttpOnly
Set-Cookie: KC_RESTART=; Version=1; Expires=Thu, 01-Jan-1970 00:00:10 GMT; Max-Age=0; Path=/auth/realms/master/; HttpOnly
Set-Cookie: KEYCLOAK_IDENTITY=eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI2YTU4ZjM4Zi00N2Y1LTQ0YmQtOTMyYy0wNTJjYWMyNGQxZDQifQ.eyJleHAiOjE2NTk4MjUxMDIsImlhdCI6MTY1OTc4OTEwMiwianRpIjoiNzNhNmQ1ZjctNWI1ZC00MDg4LWEzMjItYWFjMzllMWMxMjkwIiwiaXNzIjoiaHR0cDovLzExMi43NC4xMTAuOTU6ODA4MC9hdXRoL3JlYWxtcy9tYXN0ZXIiLCJzdWIiOiIyM2NhOWQzZi0yNmUzLTRkMTQtYjNhNC02YTAzZWNkNDNkMWUiLCJ0eXAiOiJTZXJpYWxpemVkLUlEIiwic2Vzc2lvbl9zdGF0ZSI6IjViZDhjMWU5LTk0MWEtNGU3My1hN2NhLTNiZDU2YmZmOWZmMCIsInN0YXRlX2NoZWNrZXIiOiI1WFRTWUxxaW5KQU5tblpOeFVIaHRvQk5XYTZyY2V0QlVkVlRYdDgwVFBZIn0.GOc9dMuHj-mYpqGXgit_Y0iu8YoOkL1jyt_dFZPm-kc; Version=1; Path=/auth/realms/master/; SameSite=None; Secure; HttpOnly
Set-Cookie: KEYCLOAK_IDENTITY_LEGACY=eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI2YTU4ZjM4Zi00N2Y1LTQ0YmQtOTMyYy0wNTJjYWMyNGQxZDQifQ.eyJleHAiOjE2NTk4MjUxMDIsImlhdCI6MTY1OTc4OTEwMiwianRpIjoiNzNhNmQ1ZjctNWI1ZC00MDg4LWEzMjItYWFjMzllMWMxMjkwIiwiaXNzIjoiaHR0cDovLzExMi43NC4xMTAuOTU6ODA4MC9hdXRoL3JlYWxtcy9tYXN0ZXIiLCJzdWIiOiIyM2NhOWQzZi0yNmUzLTRkMTQtYjNhNC02YTAzZWNkNDNkMWUiLCJ0eXAiOiJTZXJpYWxpemVkLUlEIiwic2Vzc2lvbl9zdGF0ZSI6IjViZDhjMWU5LTk0MWEtNGU3My1hN2NhLTNiZDU2YmZmOWZmMCIsInN0YXRlX2NoZWNrZXIiOiI1WFRTWUxxaW5KQU5tblpOeFVIaHRvQk5XYTZyY2V0QlVkVlRYdDgwVFBZIn0.GOc9dMuHj-mYpqGXgit_Y0iu8YoOkL1jyt_dFZPm-kc; Version=1; Path=/auth/realms/master/; HttpOnly
Set-Cookie: KEYCLOAK_SESSION=master/23ca9d3f-26e3-4d14-b3a4-6a03ecd43d1e/5bd8c1e9-941a-4e73-a7ca-3bd56bff9ff0; Version=1; Expires=Sat, 06-Aug-2022 22:31:42 GMT; Max-Age=36000; Path=/auth/realms/master/; SameSite=None; Secure
Set-Cookie: KEYCLOAK_SESSION_LEGACY=master/23ca9d3f-26e3-4d14-b3a4-6a03ecd43d1e/5bd8c1e9-941a-4e73-a7ca-3bd56bff9ff0; Version=1; Expires=Sat, 06-Aug-2022 22:31:42 GMT; Max-Age=36000; Path=/auth/realms/master/
Set-Cookie: KEYCLOAK_REMEMBER_ME=; Version=1; Comment=Expiring cookie; Expires=Thu, 01-Jan-1970 00:00:10 GMT; Max-Age=0; Path=/auth/realms/master/; HttpOnly
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
X-Robots-Tag: none
X-XSS-Protection: 1; mode=block

响应体：无

# 获取token

http://112.74.110.95:8080/auth/realms/master/protocol/openid-connect/token

code=61817402-f0bf-465a-9535-ebe57abd7196.5bd8c1e9-941a-4e73-a7ca-3bd56bff9ff0.151cf6cb-2dea-405a-8951-d73e47218b5c&grant_type=authorization_code&client_id=security-admin-console&redirect_uri=http%3A%2F%2F112.74.110.95%3A8080%2Fauth%2Fadmin%2Fmaster%2Fconsole%2F%23%2Frealms%2Fdemo%2Fclients&code_verifier=BTPUX1UH1qmagYckrmpjB0wlnMt7ZOY4W6lPoLH0zycRrLbi35XdXGpw6AHCWke6EIe7wfVqta1ZEwqWOW4gg90LI2nfGJW6

其实参数就是：
code: 61817402-f0bf-465a-9535-ebe57abd7196.5bd8c1e9-941a-4e73-a7ca-3bd56bff9ff0.151cf6cb-2dea-405a-8951-d73e47218b5c
grant_type: authorization_code
client_id: security-admin-console
redirect_uri: http%3A%2F%2F112.74.110.95%3A8080%2Fauth%2Fadmin%2Fmaster%2Fconsole%2F%23%2Frealms%2Fdemo%2Fclients
code_verifier: BTPUX1UH1qmagYckrmpjB0wlnMt7ZOY4W6lPoLH0zycRrLbi35XdXGpw6AHCWke6EIe7wfVqta1ZEwqWOW4gg90LI2nfGJW6

响应：
{"access_token":"eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJfdTBOQkxoZFNrLWNxN1JFOWJQOWZNOGd2Z2ZPcFlia0FKYkRLOU5mUXNvIn0.eyJleHAiOjE2NTk3ODkxNjQsImlhdCI6MTY1OTc4OTEwNCwiYXV0aF90aW1lIjoxNjU5Nzg5MTAyLCJqdGkiOiJlMzBiNThlMC1hNDU3LTRhZmEtOThlNy1iNjZjNTJlZWZmNmUiLCJpc3MiOiJodHRwOi8vMTEyLjc0LjExMC45NTo4MDgwL2F1dGgvcmVhbG1zL21hc3RlciIsInN1YiI6IjIzY2E5ZDNmLTI2ZTMtNGQxNC1iM2E0LTZhMDNlY2Q0M2QxZSIsInR5cCI6IkJlYXJlciIsImF6cCI6InNlY3VyaXR5LWFkbWluLWNvbnNvbGUiLCJub25jZSI6ImRmZWYzMmU1LTQwYWQtNDBkMC04YWY4LTAwYmIxNjRkOWU0NCIsInNlc3Npb25fc3RhdGUiOiI1YmQ4YzFlOS05NDFhLTRlNzMtYTdjYS0zYmQ1NmJmZjlmZjAiLCJhY3IiOiIxIiwiYWxsb3dlZC1vcmlnaW5zIjpbImh0dHA6Ly8xMTIuNzQuMTEwLjk1OjgwODAiXSwic2NvcGUiOiJvcGVuaWQgcHJvZmlsZSBlbWFpbCIsImVtYWlsX3ZlcmlmaWVkIjpmYWxzZSwicHJlZmVycmVkX3VzZXJuYW1lIjoiYWRtaW4ifQ.k3GB8mc3lUzQFeeR9xNzUTEuetAZT0BipWp0dIOiAUiIQVMxgRxIMp__uCglrFssrePUd1mkeFocX3kOEsGoaWKFecPJWBS60jNKP8pXuZzzRPxQ29IZYhjjQfc-Wgg4JDwDRaoHisc3RlH351iMW5Zzey5XEWPCYNBtwe9Jpsqu044nx-vI6xZ6Y7i1-IanrN7RkLhV_0XV4iRu9Tkemv76mSQqW4E-5zQF7SOMOn3agEwCtrXOxfTrVjwHwMPHKSj0CUxTHCv1ihrUibTIbyYKP0Vl88x93aFdGiwgqmvENGxgUKuIWbx5L79-yLlnGzbQM23_0G7ddJSC6Sta6g","expires_in":60,"refresh_expires_in":1800,"refresh_token":"eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI2YTU4ZjM4Zi00N2Y1LTQ0YmQtOTMyYy0wNTJjYWMyNGQxZDQifQ.eyJleHAiOjE2NTk3OTA5MDQsImlhdCI6MTY1OTc4OTEwNCwianRpIjoiOWM4ZGNjYWUtMzM0NS00MjZmLWIzYWEtMmVmYTdjMWExZWRmIiwiaXNzIjoiaHR0cDovLzExMi43NC4xMTAuOTU6ODA4MC9hdXRoL3JlYWxtcy9tYXN0ZXIiLCJhdWQiOiJodHRwOi8vMTEyLjc0LjExMC45NTo4MDgwL2F1dGgvcmVhbG1zL21hc3RlciIsInN1YiI6IjIzY2E5ZDNmLTI2ZTMtNGQxNC1iM2E0LTZhMDNlY2Q0M2QxZSIsInR5cCI6IlJlZnJlc2giLCJhenAiOiJzZWN1cml0eS1hZG1pbi1jb25zb2xlIiwibm9uY2UiOiJkZmVmMzJlNS00MGFkLTQwZDAtOGFmOC0wMGJiMTY0ZDllNDQiLCJzZXNzaW9uX3N0YXRlIjoiNWJkOGMxZTktOTQxYS00ZTczLWE3Y2EtM2JkNTZiZmY5ZmYwIiwic2NvcGUiOiJvcGVuaWQgcHJvZmlsZSBlbWFpbCJ9.lIPuxycOQK3bP5RwGF7KV_LrZcJ9URpSVF-KGp8yK_E","token_type":"Bearer","id_token":"eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJfdTBOQkxoZFNrLWNxN1JFOWJQOWZNOGd2Z2ZPcFlia0FKYkRLOU5mUXNvIn0.eyJleHAiOjE2NTk3ODkxNjQsImlhdCI6MTY1OTc4OTEwNCwiYXV0aF90aW1lIjoxNjU5Nzg5MTAyLCJqdGkiOiJmNmM4OGViZS1mZmIyLTRiNWMtYjlkMi0yYTUyMTA1MDA0ZTQiLCJpc3MiOiJodHRwOi8vMTEyLjc0LjExMC45NTo4MDgwL2F1dGgvcmVhbG1zL21hc3RlciIsImF1ZCI6InNlY3VyaXR5LWFkbWluLWNvbnNvbGUiLCJzdWIiOiIyM2NhOWQzZi0yNmUzLTRkMTQtYjNhNC02YTAzZWNkNDNkMWUiLCJ0eXAiOiJJRCIsImF6cCI6InNlY3VyaXR5LWFkbWluLWNvbnNvbGUiLCJub25jZSI6ImRmZWYzMmU1LTQwYWQtNDBkMC04YWY4LTAwYmIxNjRkOWU0NCIsInNlc3Npb25fc3RhdGUiOiI1YmQ4YzFlOS05NDFhLTRlNzMtYTdjYS0zYmQ1NmJmZjlmZjAiLCJhdF9oYXNoIjoialVrX3llNER1bXA2SzBjdlROWHMtZyIsImFjciI6IjEiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInByZWZlcnJlZF91c2VybmFtZSI6ImFkbWluIn0.Ua6RfxuQfBD791qA91sqzjtoXlb_H4VZQPWKCOVQK2JuNxRzeSxH02p-Sww9Wobr3y74nul3Sl54n-xWMDhr1mFg7jCn0k7lmKMmimEMWyCrnCDz-a7rbX2RYBWcbOoCKlI2ckvijP5XdzfwwAsRrzYk4QMvyZSIqoMNs-h2Se8p2NX6L57lhVa9bwuOLwCzkOljaIi0HqN_HzJNAWbMrIe7gMb3moIlHdt2wXht5_qfEeGa2m9ya7WX7LjMAPACtinKmgnQ8UTpMD8NiVuYJ0LaI6hrb0ig3NCJ0QuEVVjyJVBpdEnHNcfkJR4YVMF3-7-BkCCaq_zBHQWc5OvoZg","not-before-policy":0,"session_state":"5bd8c1e9-941a-4e73-a7ca-3bd56bff9ff0","scope":"openid profile email"}

即 json ：
access_token: "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJfdTBOQkxoZFNrLWNxN1JFOWJQOWZNOGd2Z2ZPcFlia0FKYkRLOU5mUXNvIn0.eyJleHAiOjE2NTk3ODkxNjQsImlhdCI6MTY1OTc4OTEwNCwiYXV0aF90aW1lIjoxNjU5Nzg5MTAyLCJqdGkiOiJlMzBiNThlMC1hNDU3LTRhZmEtOThlNy1iNjZjNTJlZWZmNmUiLCJpc3MiOiJodHRwOi8vMTEyLjc0LjExMC45NTo4MDgwL2F1dGgvcmVhbG1zL21hc3RlciIsInN1YiI6IjIzY2E5ZDNmLTI2ZTMtNGQxNC1iM2E0LTZhMDNlY2Q0M2QxZSIsInR5cCI6IkJlYXJlciIsImF6cCI6InNlY3VyaXR5LWFkbWluLWNvbnNvbGUiLCJub25jZSI6ImRmZWYzMmU1LTQwYWQtNDBkMC04YWY4LTAwYmIxNjRkOWU0NCIsInNlc3Npb25fc3RhdGUiOiI1YmQ4YzFlOS05NDFhLTRlNzMtYTdjYS0zYmQ1NmJmZjlmZjAiLCJhY3IiOiIxIiwiYWxsb3dlZC1vcmlnaW5zIjpbImh0dHA6Ly8xMTIuNzQuMTEwLjk1OjgwODAiXSwic2NvcGUiOiJvcGVuaWQgcHJvZmlsZSBlbWFpbCIsImVtYWlsX3ZlcmlmaWVkIjpmYWxzZSwicHJlZmVycmVkX3VzZXJuYW1lIjoiYWRtaW4ifQ.k3GB8mc3lUzQFeeR9xNzUTEuetAZT0BipWp0dIOiAUiIQVMxgRxIMp__uCglrFssrePUd1mkeFocX3kOEsGoaWKFecPJWBS60jNKP8pXuZzzRPxQ29IZYhjjQfc-Wgg4JDwDRaoHisc3RlH351iMW5Zzey5XEWPCYNBtwe9Jpsqu044nx-vI6xZ6Y7i1-IanrN7RkLhV_0XV4iRu9Tkemv76mSQqW4E-5zQF7SOMOn3agEwCtrXOxfTrVjwHwMPHKSj0CUxTHCv1ihrUibTIbyYKP0Vl88x93aFdGiwgqmvENGxgUKuIWbx5L79-yLlnGzbQM23_0G7ddJSC6Sta6g"
expires_in: 60
id_token: "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJfdTBOQkxoZFNrLWNxN1JFOWJQOWZNOGd2Z2ZPcFlia0FKYkRLOU5mUXNvIn0.eyJleHAiOjE2NTk3ODkxNjQsImlhdCI6MTY1OTc4OTEwNCwiYXV0aF90aW1lIjoxNjU5Nzg5MTAyLCJqdGkiOiJmNmM4OGViZS1mZmIyLTRiNWMtYjlkMi0yYTUyMTA1MDA0ZTQiLCJpc3MiOiJodHRwOi8vMTEyLjc0LjExMC45NTo4MDgwL2F1dGgvcmVhbG1zL21hc3RlciIsImF1ZCI6InNlY3VyaXR5LWFkbWluLWNvbnNvbGUiLCJzdWIiOiIyM2NhOWQzZi0yNmUzLTRkMTQtYjNhNC02YTAzZWNkNDNkMWUiLCJ0eXAiOiJJRCIsImF6cCI6InNlY3VyaXR5LWFkbWluLWNvbnNvbGUiLCJub25jZSI6ImRmZWYzMmU1LTQwYWQtNDBkMC04YWY4LTAwYmIxNjRkOWU0NCIsInNlc3Npb25fc3RhdGUiOiI1YmQ4YzFlOS05NDFhLTRlNzMtYTdjYS0zYmQ1NmJmZjlmZjAiLCJhdF9oYXNoIjoialVrX3llNER1bXA2SzBjdlROWHMtZyIsImFjciI6IjEiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInByZWZlcnJlZF91c2VybmFtZSI6ImFkbWluIn0.Ua6RfxuQfBD791qA91sqzjtoXlb_H4VZQPWKCOVQK2JuNxRzeSxH02p-Sww9Wobr3y74nul3Sl54n-xWMDhr1mFg7jCn0k7lmKMmimEMWyCrnCDz-a7rbX2RYBWcbOoCKlI2ckvijP5XdzfwwAsRrzYk4QMvyZSIqoMNs-h2Se8p2NX6L57lhVa9bwuOLwCzkOljaIi0HqN_HzJNAWbMrIe7gMb3moIlHdt2wXht5_qfEeGa2m9ya7WX7LjMAPACtinKmgnQ8UTpMD8NiVuYJ0LaI6hrb0ig3NCJ0QuEVVjyJVBpdEnHNcfkJR4YVMF3-7-BkCCaq_zBHQWc5OvoZg"
not-before-policy: 0
refresh_expires_in: 1800
refresh_token: "eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI2YTU4ZjM4Zi00N2Y1LTQ0YmQtOTMyYy0wNTJjYWMyNGQxZDQifQ.eyJleHAiOjE2NTk3OTA5MDQsImlhdCI6MTY1OTc4OTEwNCwianRpIjoiOWM4ZGNjYWUtMzM0NS00MjZmLWIzYWEtMmVmYTdjMWExZWRmIiwiaXNzIjoiaHR0cDovLzExMi43NC4xMTAuOTU6ODA4MC9hdXRoL3JlYWxtcy9tYXN0ZXIiLCJhdWQiOiJodHRwOi8vMTEyLjc0LjExMC45NTo4MDgwL2F1dGgvcmVhbG1zL21hc3RlciIsInN1YiI6IjIzY2E5ZDNmLTI2ZTMtNGQxNC1iM2E0LTZhMDNlY2Q0M2QxZSIsInR5cCI6IlJlZnJlc2giLCJhenAiOiJzZWN1cml0eS1hZG1pbi1jb25zb2xlIiwibm9uY2UiOiJkZmVmMzJlNS00MGFkLTQwZDAtOGFmOC0wMGJiMTY0ZDllNDQiLCJzZXNzaW9uX3N0YXRlIjoiNWJkOGMxZTktOTQxYS00ZTczLWE3Y2EtM2JkNTZiZmY5ZmYwIiwic2NvcGUiOiJvcGVuaWQgcHJvZmlsZSBlbWFpbCJ9.lIPuxycOQK3bP5RwGF7KV_LrZcJ9URpSVF-KGp8yK_E"
scope: "openid profile email"
session_state: "5bd8c1e9-941a-4e73-a7ca-3bd56bff9ff0"
token_type: "Bearer"

其中 access_token、id_token 、refresh_token 都是 jwt格式！
 在网站JSON Web Tokens - jwt.io中解析access token，发现能获取到realm role信息，以及资源访问权限 resource_access等信息。
 


# 使用keycloak API
Keycloak提供了一个用于生成和刷新access token的REST API。我们可以轻松地使用这个API创建自己的登录页面。
首先，我们需要通过发送一个POST请求到这个URL来获取Keycloak的access token:

http://localhost:8082/auth/realms/SpringBootKeycloak/protocol/openid-connect/token

这个POST请求的body负载如下，格式是 x-www-form-urlencoded: 

client_id:<your_client_id>
username:<your_username>
password:<your_password>
grant_type:password

在Reponse中，我们能够获得access_token跟refresh_token。

access_token应该在每个对keycloak保护的资源的请求中使用，只需将它放在授权头中:

headers: {
    'Authorization': 'Bearer' + access_token
}

一旦access_token过期，那么我们可以使用refresh_token去刷新它，得到一个新的有效的access_token，也是使用上面的API，不过body信息要使用refresh_token.

{
    'client_id': 'your_client_id',
    'refresh_token': refresh_token_from_previous_request,
    'grant_type': 'refresh_token'
}

3.拿到用户role信息。
我们当然可以通过解析access token获取到role信息，但如果有的keycloak版本的access token中没有role信息，或者用户role信息在登录后有改变的情况下，我们应该使用其它的方式去重新获取role信息，现在有两种方式获取用户role信息。

1.将role信息添加到userinfo
给用户添加role信息，下图中给用户cctf_admin添加了 ROLE_VIEWER 这个Realm Role。


请求用户信息userinfo的API(GET请求)：http://{server}/auth/realms/{realm}/protocol/openid-connect/userinfo (例如 http://localhost:8082/auth/realms/master/protocol/openid-connect/userinfo)

将access token添加到header中。

headers={
    'Authorization': 'Bearer ' + accessToken,
    'Content-Type': 'application/json'
}
发送请求后，得到下面的信息，发现没有拿到role信息，只拿到了基本信息，用户名cctf_admin，email信息等等。

{"sub": "1b535469-2d7c-45ef-bdd5-4b9343b91f9b", "email_verified": false, "name": "bruce wang", "preferred_username": "cctf_admin", "given_name": "bruce", "family_name": "wang", "email": "4xxxxxxxx@qq.com"}
怎样才能拿到role信息呢？可以通过在client中配置"User Realm Role" Mapper的方式。


————————————————
版权声明：本文为CSDN博主「知难行难1985」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/wdquan19851029/article/details/112395600
